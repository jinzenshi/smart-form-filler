<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ™ºèƒ½å¡«è¡¨åŠ©æ‰‹</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:720px;margin:24px auto;padding:0 16px}
    h1{font-size:22px}
    label{display:block;margin:12px 0 6px}
    input,textarea,button{width:100%}
    textarea{min-height:160px}
    .row{display:flex;gap:12px}
    .row>div{flex:1}
    .note{color:#666;font-size:13px;margin-top:4px}
    .actions{margin-top:16px}
  </style>
  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');
    const isAdmin = localStorage.getItem('is_admin') === 'true';

    if (!token) {
      window.location.href = '/login';
    }

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    window.addEventListener('DOMContentLoaded', () => {
      if (username) {
        const userInfoDiv = document.createElement('div');
        userInfoDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: white; padding: 10px 15px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000;';
        userInfoDiv.innerHTML = `
          <div style="font-size: 14px; margin-bottom: 5px;">ğŸ‘¤ ${username}</div>
          <div style="display: flex; gap: 10px;">
            <a href="/admin" style="font-size: 12px; color: #667eea; text-decoration: none; display: ${isAdmin ? 'block' : 'none'};">åå°ç®¡ç†</a>
            <a href="#" onclick="logout()" style="font-size: 12px; color: #dc3545; text-decoration: none;">é€€å‡ºç™»å½•</a>
          </div>
        `;
        document.body.appendChild(userInfoDiv);
      }
    });

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('is_admin');
      window.location.href = '/login';
    }

    async function submitForm(e){
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = '/login';
        return;
      }

      const docx = document.getElementById('docx').files[0];
      const photo = document.getElementById('photo').files[0] || null;
      const userInfoFile = document.getElementById('user_info').files[0];

      if(!docx){ alert('è¯·ä¸Šä¼  Word æ¨¡æ¿'); return; }
      if(!userInfoFile){ alert('è¯·ä¸Šä¼ ä¸ªäººèµ„æ–™æ–‡ä»¶'); return; }

      // è¯»å–ä¸ªäººä¿¡æ¯æ–‡ä»¶å†…å®¹
      const userInfoText = await userInfoFile.text();

      const fd = new FormData();
      fd.append('docx', docx);
      if(photo) fd.append('photo', photo);
      fd.append('user_info_text', userInfoText);
      fd.append('auth_token', token);  // åœ¨è¡¨å•ä¸­å‘é€token

      const btn = document.getElementById('submit');
      btn.disabled = true; btn.textContent = 'å¤„ç†ä¸­...';
      try{
        const res = await fetch('/api/process', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: fd
        });

        if(!res.ok){
          let errorMessage = 'å¤„ç†å¤±è´¥';
          try {
            const errorData = await res.json();
            errorMessage = errorData.error || JSON.stringify(errorData);
          } catch (e) {
            // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œè·å–æ–‡æœ¬
            const errorText = await res.text();
            errorMessage = errorText || `HTTP ${res.status}`;
          }
          throw new Error(errorMessage);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'æŠ¥åè¡¨_å·²å¡«å†™.docx';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        alert('âœ… å¤„ç†æˆåŠŸï¼æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½');
      }catch(err){
        console.error('å¤„ç†é”™è¯¯:', err);
        alert('âŒ å‡ºé”™ï¼š' + err.message + '\n\nè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°(F12)è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯');
      }finally{
        btn.disabled = false; btn.textContent = 'ç”Ÿæˆ Word æ–‡ä»¶';
      }
    }
    window.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('form').addEventListener('submit', submitForm);
    });
  </script>
  </head>
<body>
  <h1>æ™ºèƒ½å¡«è¡¨åŠ©æ‰‹</h1>
  <form id="form">
    <label>ä¸Šä¼  Word æ¨¡æ¿ï¼ˆ.docxï¼‰</label>
    <input id="docx" type="file" accept=".docx" required>
    <div class="note">è¡¨æ ¼ä¸­çš„ç©ºå•å…ƒæ ¼å°†è‡ªåŠ¨é¢„ç½®ä¸º {1}, {2}, ...</div>
    <label>ä¸Šä¼ è¯ä»¶ç…§ï¼ˆå¯é€‰ï¼‰</label>
    <input id="photo" type="file" accept="image/*">
    <div class="note">è‹¥è¡¨æ ¼ä¸­å«"ç…§ç‰‡/ç›¸ç‰‡/è¯ä»¶ç…§"ç­‰å­—æ ·ï¼Œå°†åœ¨å¯¹åº”å•å…ƒæ ¼æ’å…¥ç…§ç‰‡</div>
    <label>ä¸Šä¼ ä¸ªäººèµ„æ–™æ–‡ä»¶ï¼ˆ.txtï¼‰</label>
    <input id="user_info" type="file" accept=".txt" required>
    <div class="note">è¯·ä¸Šä¼ åŒ…å«ä¸ªäººä¿¡æ¯çš„txtæ–‡ä»¶ï¼Œå¦‚å§“åã€è”ç³»æ–¹å¼ã€æ•™è‚²ç»å†ç­‰</div>
    <div class="actions">
      <button id="submit" type="submit">ç”Ÿæˆ Word æ–‡ä»¶</button>
    </div>
    <div class="note">æœåŠ¡ç«¯éœ€å·²é…ç½®ç¯å¢ƒå˜é‡ ARK_API_KEYï¼›å¦‚éœ€æ›´æ¢æ¨¡å‹å¯è®¾ç½® MODEL_ENDPOINTã€‚</div>
    <div style="text-align: center; margin-top: 20px;">
      <a href="/feedback" style="color: #667eea; text-decoration: none; font-size: 14px;">ğŸ’¬ æ„è§åé¦ˆ</a>
    </div>
  </form>
</body>
</html>

