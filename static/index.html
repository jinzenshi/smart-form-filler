<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ™ºèƒ½å¡«è¡¨åŠ©æ‰‹</title>
  <style>
    *{box-sizing: border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container{
      max-width: 1400px;
      margin: 30px auto;
      padding: 20px;
    }
    .card{
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      display: flex;
      gap: 30px;
    }

    /* å·¦ä¾§è¡¨å•åŒºåŸŸ */
    .form-section{
      flex: 0 0 450px;
    }

    /* å³ä¾§é¢„è§ˆåŒºåŸŸ */
    .preview-section-wrapper{
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    /* é¢„è§ˆåŒºåŸŸåœ¨å³ä¾§æ—¶çš„æ ·å¼ */
    .preview-section-wrapper .preview-section{
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .preview-section-wrapper .preview-title{
      margin-bottom: 15px;
    }

    .preview-section-wrapper .preview-container{
      flex: 1;
    }

    .preview-section-wrapper .confirm-download{
      margin-top: 15px;
    }

    /* æ»šåŠ¨æç¤º */
    .preview-container::-webkit-scrollbar{
      width: 12px;
      height: 12px;
    }
    .preview-container::-webkit-scrollbar-track{
      background: #e0e0e0;
      border-radius: 6px;
    }
    .preview-container::-webkit-scrollbar-thumb{
      background: #667eea;
      border-radius: 6px;
    }
    .preview-container::-webkit-scrollbar-thumb:hover{
      background: #5568d3;
    }
    h1{
      text-align: center;
      margin: 0 0 40px;
      color: #333;
      font-size: 32px;
      font-weight: 700;
    }
    .subtitle{
      text-align: center;
      color: #666;
      margin-bottom: 40px;
      font-size: 16px;
    }
    label{
      display: block;
      margin: 25px 0 10px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input[type="file"]{
      width: 100%;
      padding: 15px;
      border: 2px dashed #ddd;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      background: #f9f9f9;
    }
    input[type="file"]:hover{
      border-color: #667eea;
      background: #f0f4ff;
    }
    input[type="file"]:focus{
      outline: none;
      border-color: #667eea;
      background: #f0f4ff;
    }
    .note{
      color: #888;
      font-size: 13px;
      margin-top: 8px;
      padding-left: 5px;
      line-height: 1.6;
    }
    .note::before{
      content: "ğŸ’¡ ";
    }
    .actions{
      margin-top: 40px;
      display: flex;
      gap: 15px;
    }
    button{
      flex: 1;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    button:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    button:active{
      transform: translateY(0);
    }
    button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    /* é¢„è§ˆæŒ‰é’®ç‰¹æ®Šæ ·å¼ */
    #preview-btn{
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }
    #preview-btn:hover{
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }
    #preview-btn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    /* ä¸‹è½½æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
    #download-btn{
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
      display: none;
    }
    #download-btn:hover{
      box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
    }

    .user-info{
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .user-info .username{
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    .user-info .links{
      display: flex;
      gap: 15px;
    }
    .user-info .links a{
      font-size: 13px;
      text-decoration: none;
      transition: all 0.2s;
    }
    .user-info .links .admin-link{
      color: #667eea;
    }
    .user-info .links .admin-link:hover{
      color: #764ba2;
    }
    .user-info .links .logout-link{
      color: #dc3545;
    }
    .user-info .links .logout-link:hover{
      opacity: 0.8;
    }
    .feedback-link{
      text-align: center;
      margin-top: 30px;
    }
    .feedback-link a{
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .feedback-link a:hover{
      color: #764ba2;
      text-decoration: underline;
    }
    .footer-note{
      text-align: center;
      margin-top: 25px;
      color: #999;
      font-size: 12px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
    .preview-section{
      margin-top: 40px;
      padding: 30px;
      background: #f8f9ff;
      border-radius: 15px;
      border: 2px solid #667eea30;
      display: none;
    }
    .preview-section.active{
      display: block;
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn{
      from{ opacity: 0; transform: translateY(20px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    .preview-title{
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      color: #667eea;
      font-size: 18px;
      font-weight: 600;
    }
    .preview-title::before{
      content: "ğŸ‘ï¸";
      font-size: 24px;
    }
    /* ä¼˜åŒ–åçš„é¢„è§ˆå®¹å™¨ */
    .preview-container {
      background: #f0f0f0;
      border-radius: 10px;
      padding: 15px;
      min-height: 600px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
      overflow: auto !important; /* å¼ºåˆ¶å…è®¸åŒå‘æ»šåŠ¨ */
      display: block; /* æ¢å¤å—çº§å¸ƒå±€ */
    }

    /* å¼ºåˆ¶è¦†ç›– docx-preview å†…éƒ¨æ ·å¼ */
    .preview-container .docx-wrapper {
      background-color: white !important;
      padding: 20px !important;
      margin: 0 auto;
      /* å…³é”®ï¼šå–æ¶ˆå›ºå®šå®½åº¦ï¼Œæ”¹ç”¨ min-content ç¡®ä¿å†…å®¹ä¸è¢«æˆªæ–­ */
      width: fit-content !important;
      min-width: 100% !important;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    /* è¡¨æ ¼æ¸²æŸ“é€»è¾‘ä¿®æ­£ */
    .preview-container .docx-wrapper table {
      /* å…³é”®ï¼šå°† fixed æ”¹ä¸º autoï¼Œè®©è¡¨æ ¼æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
      table-layout: auto !important;
      width: auto !important; /* å…è®¸è¡¨æ ¼è¶…å‡ºçˆ¶çº§å®½åº¦ */
      min-width: 100% !important;
      word-break: normal !important; /* é¿å…é•¿è‹±æ–‡/æ•°å­—å¼ºè¡Œæ–­è¡Œ */
      overflow-wrap: break-word;
      border-collapse: collapse !important;
    }

    .preview-container .docx-wrapper td {
      border: 1px solid #000 !important; /* å¢å¼ºè¾¹æ¡†å¯è§åº¦ */
      min-width: 50px; /* è®¾ç½®æœ€å°å•å…ƒæ ¼å®½åº¦é˜²æ­¢æŒ¤å‹ */
      white-space: nowrap; /* å°½é‡ä¿æŒå†…å®¹ä¸æ¢è¡Œä»¥æ’‘å¼€è¡¨æ ¼ï¼Œå¦‚éœ€æ¢è¡Œå¯å»æ‰æ­¤é¡¹ */
    }

    /* AI æ€è€ƒä¸­çš„åŠ è½½æç¤º */
    .ai-thinking {
      color: #667eea;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }

    .ai-thinking::before {
      content: "ğŸ¤– ";
      font-size: 18px;
    }
    .preview-note{
      text-align: center;
      color: #999;
      padding: 60px 20px;
    }
    .loading-spinner{
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(360deg); }
    }
    .confirm-download{
      margin-top: 20px;
      padding: 20px;
      background: #e8f4f8;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    .confirm-download p{
      margin: 0 0 15px 0;
      color: #555;
      font-size: 14px;
      line-height: 1.6;
    }

    /* DOCX é¢„è§ˆè‡ªå®šä¹‰æ ·å¼ */
    .preview-container .docx-wrapper{
      padding: 20px !important;
      background-color: #f8f9fa !important;
      min-width: 100% !important;
    }

    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
    .preview-container .docx-wrapper table{
      width: 100% !important;
      max-width: 100% !important;
      table-layout: fixed !important;
      word-wrap: break-word !important;
      border-collapse: collapse !important;
    }

    .preview-container .docx-wrapper table td{
      padding: 8px 12px !important;
      border: 1px solid #ddd !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    .preview-container .docx-wrapper table th{
      padding: 8px 12px !important;
      border: 1px solid #ddd !important;
      background-color: #f0f0f0 !important;
      font-weight: bold !important;
      text-align: center !important;
    }

    /* æ®µè½å’Œæ ‡é¢˜æ ·å¼ */
    .preview-container .docx-wrapper h1,
    .preview-container .docx-wrapper h2,
    .preview-container .docx-wrapper h3{
      color: #333 !important;
      margin: 16px 0 8px 0 !important;
      page-break-after: avoid !important;
    }

    .preview-container .docx-wrapper p{
      margin: 8px 0 !important;
      line-height: 1.6 !important;
      color: #444 !important;
    }

    /* å“åº”å¼è¡¨æ ¼ï¼ˆåœ¨å°å±å¹•ä¸Šæ»šåŠ¨ï¼‰ */
    .preview-container{
      overflow-x: auto !important;
      overflow-y: auto !important;
      -webkit-overflow-scrolling: touch;
    }

    /* å½“è¡¨æ ¼å¤ªå®½æ—¶è‡ªåŠ¨ç¼©å°å­—ä½“ */
    .preview-container .docx-wrapper table{
      font-size: 12px !important;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
    .preview-container::-webkit-scrollbar{
      width: 10px;
      height: 10px;
    }
    .preview-container::-webkit-scrollbar-track{
      background: #f1f1f1;
      border-radius: 10px;
    }
    .preview-container::-webkit-scrollbar-thumb{
      background: #667eea;
      border-radius: 10px;
    }
    .preview-container::-webkit-scrollbar-thumb:hover{
      background: #5568d3;
    }
  </style>
  <!-- åŠ¨æ€åŠ è½½ä¾èµ–åº“ -->
  <script>
    // å…ˆåŠ è½½ jszip ä¾èµ–
    const loadJSZip = () => {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
        script.onload = () => {
          console.log('âœ… jszip ä¾èµ–åŠ è½½æˆåŠŸ');
          resolve();
        };
        script.onerror = () => {
          console.warn('âŒ jszip åŠ è½½å¤±è´¥ï¼Œå°è¯• unpkg...');
          const script2 = document.createElement('script');
          script2.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
          script2.onload = () => {
            console.log('âœ… jszip ä» unpkg åŠ è½½æˆåŠŸ');
            resolve();
          };
          script2.onerror = () => reject(new Error('jszip åŠ è½½å¤±è´¥'));
          document.head.appendChild(script2);
        };
        document.head.appendChild(script);
      });
    };

    // å¤šä¸ª CDN æºå¤‡é€‰
    const cdnSources = [
      'https://cdn.jsdelivr.net/npm/docx-preview@0.3.7/dist/docx-preview.min.js',
      'https://unpkg.com/docx-preview@0.3.7/dist/docx-preview.min.js',
      'https://cdn.jsdelivr.net/npm/docx-preview@latest/dist/docx-preview.min.js'
    ];

    let cdnIndex = 0;
    let docxLoading = false;

    function loadDocxFromCDN() {
      return new Promise((resolve, reject) => {
        console.log('ğŸš€ å¼€å§‹åŠ è½½ docx-preview ä¾èµ–...');

        // å…ˆåŠ è½½ jszip
        loadJSZip().then(() => {
          console.log('âœ… jszip ä¾èµ–åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½ docx-preview...');

          if (cdnIndex >= cdnSources.length) {
            reject(new Error('æ‰€æœ‰ CDN æºéƒ½æ— æ³•åŠ è½½ docx-preview åº“'));
            return;
          }

          const script = document.createElement('script');
          script.src = cdnSources[cdnIndex];
          script.async = true;

          script.onload = () => {
            script.dataset.loaded = "true"; // æ ‡è®°å·²åŠ è½½ï¼Œé˜²æ­¢è§¦å‘è¶…æ—¶é€»è¾‘
            console.log(`âœ… ä» CDN ${cdnIndex + 1} åŠ è½½ docx-preview æˆåŠŸ`);
            console.log('  - åŸå§‹ docx å˜é‡:', typeof docx);
            console.log('  - window.docx:', typeof window.docx);

            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿å…¨å±€å˜é‡æ›´æ–°
            setTimeout(() => {
              // è¯¦ç»†æ£€æŸ¥ docx å¯¹è±¡ç»“æ„
              console.log('è¯¦ç»†æ£€æŸ¥:');
              console.log('  - docx:', docx);
              console.log('  - window.docx:', window.docx);
              console.log('  - window.docx.renderAsync:', typeof window.docx?.renderAsync);
              console.log('  - docx.renderAsync:', typeof docx?.renderAsync);
              console.log('  - JSZip:', typeof JSZip);

              // ç¡®ä¿ docx åº“åŠ è½½åˆ°å…¨å±€å˜é‡
              if (typeof docx !== 'undefined') {
                window.docx = docx;
                console.log('âœ… docx å˜é‡å·²è®¾ç½®åˆ° window.docx');
                resolve(docx);
              } else if (typeof window.docx !== 'undefined') {
                console.log('âœ… ä½¿ç”¨ window.docx');
                resolve(window.docx);
              } else {
                console.error('âŒ docx å˜é‡æœªå®šä¹‰');
                reject(new Error('docx å˜é‡æœªå®šä¹‰'));
              }
            }, 100);
          };

          script.onerror = () => {
            console.warn(`âŒ CDN ${cdnIndex + 1} åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
            cdnIndex++;
            loadDocxFromCDN().then(resolve).catch(reject);
          };

          // è®¾ç½®è¶…æ—¶
          setTimeout(() => {
            if (!script.dataset.loaded) {
              script.onerror();
            }
          }, 10000);

          document.head.appendChild(script);
        }).catch(err => {
          console.error('âŒ jszip åŠ è½½å¤±è´¥:', err);
          reject(err);
        });
      });
    }

    // ç«‹å³å¼€å§‹åŠ è½½åº“
    loadDocxFromCDN().catch(err => {
      console.error('âŒ docx-preview åº“åŠ è½½å¤±è´¥:', err);
    });

    // === ç»Ÿä¸€çš„èº«ä»½éªŒè¯é€»è¾‘ ===
    (function handleAuthentication() {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('t');

      // 1. ä¼˜å…ˆå¤„ç† URL ä¼ æ¥çš„æ–° Token
      if (tokenFromUrl) {
        localStorage.setItem('user_token', tokenFromUrl);
        console.log('ğŸ”‘ Tokenç™»å½•æˆåŠŸ:', tokenFromUrl.substring(0, 8) + '...');
        // ç«‹å³æ¸…ç† URL é¿å…åˆ·æ–°æ—¶é‡å¤è§¦å‘ï¼Œä½†ä¸è¦è·³è½¬
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // 2. æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦å­˜åœ¨ä»»ä¸€æœ‰æ•ˆ Token
      const token = localStorage.getItem('token');
      const userToken = localStorage.getItem('user_token');

      // 3. åªæœ‰å½“ä¸¤è€…éƒ½ä¸å­˜åœ¨æ—¶ï¼Œæ‰è·³è½¬åˆ°ç™»å½•é¡µ
      if (!token && !userToken) {
        console.log('ğŸš« æ— æœ‰æ•ˆå‡­è¯ï¼Œè·³è½¬ç™»å½•');
        window.location.href = '/login';
        return;
      }

      console.log('âœ… èº«ä»½éªŒè¯é€šè¿‡');
    })();

    // è·å–å…¶ä»–ç”¨æˆ·ä¿¡æ¯
    const username = localStorage.getItem('username');
    const isAdmin = localStorage.getItem('is_admin') === 'true';

    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    window.addEventListener('DOMContentLoaded', () => {
      if (username) {
        const userInfoDiv = document.createElement('div');
        userInfoDiv.className = 'user-info';
        userInfoDiv.innerHTML = `
          <div class="username">ğŸ‘¤ ${username}</div>
          <div class="links">
            <a href="/admin" class="admin-link" style="display: ${isAdmin ? 'block' : 'none'};">åå°ç®¡ç†</a>
            <a href="#" onclick="logout()" class="logout-link">é€€å‡ºç™»å½•</a>
          </div>
        `;
        document.body.appendChild(userInfoDiv);
      }

      // æ˜¾ç¤ºTokenä½™é¢ä¿¡æ¯
      showTokenBalance();
    });

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user_token');
      localStorage.removeItem('username');
      localStorage.removeItem('is_admin');
      window.location.href = '/login';
    }

    let currentPreviewData = null;

    // ç­‰å¾… docx-preview åº“åŠ è½½
    function waitForDocxLibrary(maxAttempts = 100) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        console.log('ç­‰å¾… docx-preview åº“åŠ è½½...');

        const checkInterval = setInterval(() => {
          attempts++;

          // æ£€æŸ¥ä¾èµ–
          console.log('ä¾èµ–æ£€æŸ¥ (å°è¯• ' + attempts + '):');
          console.log('  - JSZip:', typeof JSZip);
          console.log('  - window.docx:', typeof window.docx);
          console.log('  - docx:', typeof docx);

          // ä¼˜å…ˆæ£€æŸ¥ window.docxï¼ˆå…¨å±€å˜é‡ï¼‰
          let docxLib = null;

          // å°è¯•ä»å„ç§å¯èƒ½çš„å…¨å±€å˜é‡è·å–
          if (typeof window !== 'undefined' && window.docx) {
            if (typeof window.docx.renderAsync === 'function') {
              docxLib = window.docx;
              console.log('âœ… ä» window.docx è·å–åˆ°åº“ï¼ˆrenderAsync å¯ç”¨ï¼‰');
            } else {
              console.log('âš ï¸ window.docx å­˜åœ¨ä½†æ—  renderAsync:', window.docx);
            }
          } else if (typeof docx !== 'undefined') {
            if (typeof docx.renderAsync === 'function') {
              docxLib = docx;
              console.log('âœ… ä» docx å…¨å±€å˜é‡è·å–åˆ°åº“ï¼ˆrenderAsync å¯ç”¨ï¼‰');
            } else {
              console.log('âš ï¸ docx å­˜åœ¨ä½†æ—  renderAsync:', docx);
            }
          } else if (typeof globalThis !== 'undefined' && globalThis.docx && typeof globalThis.docx.renderAsync === 'function') {
            docxLib = globalThis.docx;
            console.log('âœ… ä» globalThis.docx è·å–åˆ°åº“ï¼ˆrenderAsync å¯ç”¨ï¼‰');
          }

          if (docxLib) {
            // æ£€æŸ¥ JSZip æ˜¯å¦å¯ç”¨
            if (typeof JSZip === 'undefined') {
              console.log('âš ï¸ JSZip æœªåŠ è½½ï¼Œç­‰å¾…...');
              return;
            }

            clearInterval(checkInterval);
            console.log('âœ… æ‰€æœ‰ä¾èµ–åŠ è½½æˆåŠŸï¼');
            console.log('  - docx-preview:', typeof docxLib.renderAsync);
            console.log('  - JSZip:', typeof JSZip);
            resolve(docxLib);
          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            console.error('âŒ docx-preview åº“åŠ è½½å¤±è´¥');
            console.error('  - JSZip:', typeof JSZip);
            console.error('  - window.docx:', typeof window.docx, window.docx);
            console.error('  - docx:', typeof docx, docx);
            console.error('  - globalThis.docx:', typeof globalThis && globalThis.docx ? typeof globalThis.docx : 'undefined', globalThis?.docx);

            // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
            const errorMsg = 'ä¾èµ–åŠ è½½å¤±è´¥ï¼\n\n' +
              `JSZip: ${typeof JSZip}\n` +
              `docx: ${typeof docx}\n` +
              `window.docx: ${typeof window.docx}\n\n` +
              'å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š\n' +
              '1. åˆ·æ–°é¡µé¢ (F5)\n' +
              '2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n' +
              '3. æ£€æŸ¥ç½‘ç»œè¿æ¥\n' +
              '4. å°è¯•ä½¿ç”¨å…¶ä»–æµè§ˆå™¨';

            alert(errorMsg);
            reject(new Error('ä¾èµ–åŠ è½½è¶…æ—¶'));
          }
        }, 100);
      });
    }

    async function generatePreview(e){
      e.preventDefault();
      const token = localStorage.getItem('token');
      if (!token) {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = '/login';
        return;
      }

      const docx = document.getElementById('docx').files[0];
      const userInfoFile = document.getElementById('user_info').files[0];
      const previewContainer = document.getElementById('preview-container');

      if(!docx){
        alert('è¯·ä¸Šä¼  Word æ¨¡æ¿');
        return;
      }
      if(!userInfoFile){
        alert('è¯·ä¸Šä¼ ä¸ªäººèµ„æ–™æ–‡ä»¶');
        return;
      }

      // è¯»å–ä¸ªäººä¿¡æ¯æ–‡ä»¶å†…å®¹
      const userInfoText = await userInfoFile.text();

      const fd = new FormData();
      fd.append('docx', docx);
      fd.append('user_info_text', userInfoText);
      fd.append('auth_token', token);
      fd.append('preview', 'true');  // å¼€å¯é¢„è§ˆæ¨¡å¼

      const btn = document.getElementById('preview-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>ç”Ÿæˆé¢„è§ˆä¸­...';

      // æ˜¾ç¤º AI æ€è€ƒä¸­çš„æç¤º
      previewContainer.innerHTML = '<div class="ai-thinking">AI æ­£åœ¨æ€è€ƒå¦‚ä½•å¡«å†™è¡¨æ ¼...</div>';

      try{
        const res = await fetch('/api/process', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: fd
        });

        if(!res.ok){
          let errorMessage = 'é¢„è§ˆç”Ÿæˆå¤±è´¥';
          try {
            const errorData = await res.json();
            errorMessage = errorData.error || JSON.stringify(errorData);
          } catch (e) {
            const errorText = await res.text();
            errorMessage = errorText || `HTTP ${res.status}`;
          }
          throw new Error(errorMessage);
        }

        const result = await res.json();
        if(result.success && result.mode === 'preview'){
          // ä¿å­˜é¢„è§ˆæ•°æ®
          currentPreviewData = {
            docx: docx,
            userInfoText: userInfoText,
            base64: result.data,
            filename: result.filename
          };

          // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
          const previewSection = document.querySelector('.preview-section');
          previewSection.classList.add('active');

          // æ¸…ç©ºé¢„è§ˆå®¹å™¨
          previewContainer.innerHTML = '<div class="preview-note"><span class="loading-spinner"></span>æ­£åœ¨æ¸²æŸ“é¢„è§ˆ...</div>';

          // å°† base64 è½¬æ¢ä¸º Blob
          const byteCharacters = atob(result.data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });

          // ä½¿ç”¨ docx-preview æ¸²æŸ“
          try{
            // æ¸…ç©ºå®¹å™¨å¹¶æ˜¾ç¤ºåŠ è½½æç¤º
            previewContainer.innerHTML = '<div class="preview-note"><span class="loading-spinner"></span>æ­£åœ¨åŠ è½½ docx-preview åº“...</div>';

            // ç­‰å¾… docx-preview åº“åŠ è½½
            const docxLib = await waitForDocxLibrary();

            // æ›´æ–°åŠ è½½æç¤º
            previewContainer.innerHTML = '<div class="preview-note"><span class="loading-spinner"></span>æ­£åœ¨æ¸²æŸ“é¢„è§ˆ...</div>';

            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ DOM æ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 200));

            // ä½¿ç”¨ docx-preview æ¸²æŸ“
            console.log('å‡†å¤‡æ¸²æŸ“...');
            console.log('  - blob:', blob);
            console.log('  - container:', previewContainer);
            console.log('  - lib:', docxLib);

            // ä½¿ç”¨ç®€åŒ–ä¸”ç¨³å¥çš„æ¸²æŸ“é…ç½®
            try {
              // docx-preview ç°ä»£ç‰ˆæœ¬æ¨èç›´æ¥ä¼ å…¥ DOM å…ƒç´ 
              await docxLib.renderAsync(blob, previewContainer, null, {
                className: "docx",
                inWrapper: true,
                ignoreWidth: false,
                breakPages: true
              });
            } catch (renderError) {
              console.error('âŒ é¢„è§ˆæ¸²æŸ“å¤±è´¥:', renderError);
              throw renderError;
            }

            console.log('é¢„è§ˆæ¸²æŸ“å®Œæˆ');

            // ç¨³å¦¥çš„"å®½åº¦è‡ªé€‚åº”"é€»è¾‘
            setTimeout(() => {
              const wrapper = previewContainer.querySelector('.docx-wrapper');
              if (wrapper) {
                // å¦‚æœå†…éƒ¨è¡¨æ ¼æ€»å®½åº¦è¶…è¿‡äº†å®¹å™¨ï¼Œå…è®¸æ¨ªå‘æ»šåŠ¨ï¼Œä¸å¼ºåˆ¶ç¼©å°
                // è¿™æ ·å¯ä»¥ä¿è¯ç”¨æˆ·é€šè¿‡æ»šåŠ¨æ¡çœ‹åˆ° 100% å®Œæ•´çš„ä¿¡æ¯
                wrapper.style.margin = "0 auto";
                console.log('åº”ç”¨å®½åº¦è‡ªé€‚åº”é€»è¾‘ - å±…ä¸­æ˜¾ç¤ºï¼Œå…è®¸æ»šåŠ¨æŸ¥çœ‹å®Œæ•´å†…å®¹');
              }
            }, 200);

            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
            document.getElementById('download-btn').style.display = 'block';

            // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
            previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            btn.textContent = 'âœ… é¢„è§ˆå·²ç”Ÿæˆ';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.disabled = false;
            }, 2000);
          } catch(renderError){
            console.error('é¢„è§ˆæ¸²æŸ“å¤±è´¥:', renderError);
            previewContainer.innerHTML = '<div class="preview-note" style="color: #e74c3c;">âŒ é¢„è§ˆæ¸²æŸ“å¤±è´¥: ' + (renderError.message || renderError) + '</div><br><div style="color: #666; font-size: 13px; text-align: left; margin-top: 10px;">è¯·æ£€æŸ¥ï¼š<br>1. æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ DOCX æ ¼å¼<br>2. æµè§ˆå™¨æ§åˆ¶å°(F12)æ˜¯å¦æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯<br>3. å°è¯•åˆ·æ–°é¡µé¢åé‡æ–°é¢„è§ˆ</div>';
            btn.disabled = false;
            btn.textContent = originalText;
            throw renderError;
          }
        } else {
          throw new Error(result.message || 'é¢„è§ˆç”Ÿæˆå¤±è´¥');
        }
      }catch(err){
        console.error('é¢„è§ˆé”™è¯¯:', err);
        alert('âŒ é¢„è§ˆå¤±è´¥ï¼š' + err.message + '\n\nè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°(F12)è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯');
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    async function downloadFile(){
      if(!currentPreviewData){
        alert('è¯·å…ˆç”Ÿæˆé¢„è§ˆ');
        return;
      }

      const btn = document.getElementById('download-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>å‡†å¤‡ä¸‹è½½...';

      try{
        const fd = new FormData();
        fd.append('docx', currentPreviewData.docx);
        fd.append('user_info_text', currentPreviewData.userInfoText);
        // æ³¨æ„ï¼šè¿™é‡Œä¸ä¼  preview å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤ä¸‹è½½æ¨¡å¼

        const res = await fetch('/api/process', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: fd
        });

        if(!res.ok){
          let errorMessage = 'ä¸‹è½½å¤±è´¥';
          try {
            const errorData = await res.json();
            errorMessage = errorData.error || JSON.stringify(errorData);
          } catch (e) {
            const errorText = await res.text();
            errorMessage = errorText || `HTTP ${res.status}`;
          }
          throw new Error(errorMessage);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'æŠ¥åè¡¨_å·²å¡«å†™.docx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        btn.textContent = 'âœ… ä¸‹è½½æˆåŠŸï¼';

        // æ›´æ–°ä½™é¢æ˜¾ç¤ºï¼ˆåªæœ‰Tokenç”¨æˆ·æ‰éœ€è¦ï¼‰
        showTokenBalance();

        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        }, 2000);
      }catch(err){
        console.error('ä¸‹è½½é”™è¯¯:', err);
        alert('âŒ ä¸‹è½½å¤±è´¥ï¼š' + err.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('preview-btn').addEventListener('click', generatePreview);
      document.getElementById('download-btn').addEventListener('click', downloadFile);
    });

    // è·å–å¹¶æ˜¾ç¤ºTokenä½™é¢
    async function showTokenBalance() {
      const token = localStorage.getItem('user_token');
      if (!token) return;

      try {
        const res = await fetch('/api/token/balance', {
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (res.ok) {
          const data = await res.json();
          console.log('ğŸ’° Tokenä½™é¢:', data);

          // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä½™é¢
          const balanceDiv = document.getElementById('token-balance');
          if (balanceDiv) {
            balanceDiv.innerHTML = `
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                          color: white; padding: 8px 15px; border-radius: 20px;
                          font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                ğŸ’° ä½™é¢: ${data.balance} / ${data.total_balance}
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('è·å–ä½™é¢å¤±è´¥:', error);
      }
    }

    // è·å–è®¤è¯å¤´éƒ¨ï¼ˆæ”¯æŒTokenå’Œæ™®é€šç”¨æˆ·ï¼‰
    function getAuthHeaders() {
      const token = localStorage.getItem('user_token') || localStorage.getItem('token');
      if (!token) return {};

      return {
        'Authorization': `Bearer ${token}`
      };
    }
  </script>
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- å·¦ä¾§ï¼šè¡¨å•åŒºåŸŸ -->
      <div class="form-section">
        <h1>ğŸš€ æ™ºèƒ½å¡«è¡¨åŠ©æ‰‹</h1>
        <div class="subtitle">AIé©±åŠ¨çš„Wordæ–‡æ¡£è‡ªåŠ¨å¡«å†™ç³»ç»Ÿ</div>

        <!-- Token ä½™é¢æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="token-balance" style="margin: 15px 0; text-align: center;"></div>

        <form id="form">
          <label>ğŸ“„ ä¸Šä¼  Word æ¨¡æ¿</label>
          <input id="docx" type="file" accept=".docx" required>
          <div class="note">ğŸ“¸ è¡¨æ ¼ä¸­çš„ç©ºå•å…ƒæ ¼å°†è‡ªåŠ¨é¢„ç½®ä¸º {1}, {2}, {3}...</div>
          <div class="note" style="margin-top: 5px;">ğŸ’¡ æç¤ºï¼šè¯·ç¡®ä¿æ¨¡æ¿ä¸­åŒ…å«åä¸º"ç…§ç‰‡"çš„å•å…ƒæ ¼ä»¥è‡ªåŠ¨æ’å…¥è¯ä»¶ç…§</div>

          <label>ğŸ“ ä¸Šä¼ ä¸ªäººèµ„æ–™æ–‡ä»¶</label>
          <input id="user_info" type="file" accept=".txt" required>
          <div class="note">è¯·ä¸Šä¼ åŒ…å«ä¸ªäººä¿¡æ¯çš„txtæ–‡ä»¶ï¼Œå¦‚å§“åã€è”ç³»æ–¹å¼ã€æ•™è‚²ç»å†ç­‰</div>

          <div class="actions">
            <button id="preview-btn" type="button">ğŸ‘ï¸ ç”Ÿæˆé¢„è§ˆ</button>
          </div>
        </form>

        <div class="feedback-link" style="margin-top: 30px;">
          <a href="/feedback">ğŸ’¬ æ„è§åé¦ˆ</a>
        </div>

        <div class="footer-note">
          â„¹ï¸ æœåŠ¡ç«¯éœ€å·²é…ç½®ç¯å¢ƒå˜é‡ ARK_API_KEY<br>
          å¦‚éœ€æ›´æ¢æ¨¡å‹å¯è®¾ç½® MODEL_ENDPOINT
        </div>
      </div>

      <!-- å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ -->
      <div class="preview-section-wrapper">
        <div class="preview-section">
          <div class="preview-title">æ–‡æ¡£é¢„è§ˆ</div>
          <div class="preview-container" id="preview-container">
            <div class="preview-note">è¯·ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"æŒ‰é’®æŸ¥çœ‹å¡«å†™åçš„æ–‡æ¡£æ•ˆæœ</div>
          </div>
          <div class="confirm-download">
            <p><strong>ğŸ’¡ æç¤ºï¼š</strong>é¢„è§ˆç¡®è®¤æ— è¯¯åï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½æœ€ç»ˆæ–‡ä»¶</p>
            <button id="download-btn" type="button">â¬‡ï¸ ç¡®è®¤å¹¶ä¸‹è½½</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
