<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åå°ç®¡ç† - æ™ºèƒ½å¡«è¡¨ç³»ç»Ÿ</title>
  <style>
    *{box-sizing: border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto;
      margin: 0;
      background: #f5f5f5;
    }
    header{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1{
      margin: 0;
      font-size: 24px;
    }
    .user-info{
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .container{
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .card{
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .card h2{
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .stats{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-box{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-box h3{
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .stat-box .number{
      font-size: 32px;
      font-weight: bold;
      margin-top: 10px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
    }
    th, td{
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th{
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    tr:hover{
      background: #f8f9fa;
      cursor: pointer;
    }
    .modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
    }
    .modal.active{
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content{
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .modal-header h3{
      margin: 0;
      color: #333;
    }
    .close-modal{
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-modal:hover{
      color: #333;
    }
    .data-field{
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .data-field label{
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
      display: block;
    }
    .data-field pre{
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: inherit;
      font-size: 14px;
    }
    .filter-box{
      margin-bottom: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .filter-box input, .filter-box select{
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      width: 200px;
      margin-right: 10px;
    }
    .filter-box button{
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .filter-box button:hover{
      background: #5568d3;
    }
    .status-badge{
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-success{
      background: #d4edda;
      color: #155724;
    }
    .status-failed{
      background: #f8d7da;
      color: #721c24;
    }
    .btn{
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    .btn:hover{
      transform: translateY(-2px);
    }
    .btn-danger{
      background: #dc3545;
    }
    .logout{
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border: 1px solid white;
      border-radius: 5px;
      transition: background 0.3s;
    }
    .logout:hover{
      background: rgba(255,255,255,0.2);
    }
  </style>
  <script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');
    const isAdmin = localStorage.getItem('is_admin') === 'true';

    console.log('ğŸ”‘ Token:', token);
    console.log('ğŸ‘¤ Username:', username);
    console.log('ğŸ” Is Admin:', isAdmin);
    console.log('ğŸ” is_admin value:', localStorage.getItem('is_admin'));
    console.log('ğŸ” is_admin === "true":', localStorage.getItem('is_admin') === 'true');

    if (!token) {
      console.log('âŒ No token found, redirecting to login');
      alert('è¯·å…ˆç™»å½•');
      window.location.href = '/login';
    } else if (!isAdmin) {
      console.log('âŒ Not admin, redirecting to home');
      alert('éœ€è¦ç®¡ç†å‘˜æƒé™');
      window.location.href = '/';
    } else {
      console.log('âœ… Admin access granted');
    }

    async function fetchStats() {
      console.log('ğŸ“Š Fetching stats with token:', token ? token.substring(0, 20) + '...' : 'NO TOKEN');
      try {
        const res = await fetch('/api/admin/stats', {
          headers: {'Authorization': `Bearer ${token}`}
        });
        console.log('ğŸ“Š Stats response status:', res.status);

        if (!res.ok) {
          const errorText = await res.text();
          console.error('è·å–ç»Ÿè®¡å¤±è´¥:', errorText);
          alert(`è·å–ç»Ÿè®¡å¤±è´¥: ${errorText}`);
          return;
        }

        const data = await res.json();

        document.getElementById('totalUsers').textContent = data.total_users;
        document.getElementById('temporaryAccounts').textContent = data.temporary_accounts || 0;
        document.getElementById('expiredAccounts').textContent = data.expired_accounts || 0;
        document.getElementById('totalOperations').textContent = data.total_operations;
        document.getElementById('successfulOps').textContent = data.successful_operations;
        document.getElementById('failedOps').textContent = data.failed_operations;
        document.getElementById('pendingFeedbacks').textContent = data.pending_feedbacks || 0;
      } catch (error) {
        console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
        alert(`è·å–ç»Ÿè®¡å¤±è´¥: ${error.message}`);
      }
    }

    async function fetchUsers() {
      try {
        const res = await fetch('/api/admin/users', {
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', errorText);
          alert(`è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${errorText}`);
          return;
        }

        const users = await res.json();

        const tbody = document.getElementById('usersTableBody');
        if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">æš‚æ— ç”¨æˆ·</td></tr>';
        } else {
          tbody.innerHTML = users.map(user => `
            <tr>
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td>${user.is_admin ? 'æ˜¯' : 'å¦'}</td>
              <td>${new Date(user.created_at).toLocaleString()}</td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        alert(`è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${error.message}`);
      }
    }

    async function fetchLogs() {
      const usernameFilter = document.getElementById('filterUsername').value;
      const operationFilter = document.getElementById('filterOperation').value;

      let url = '/api/admin/logs?limit=100';
      if (usernameFilter) url += `&username=${encodeURIComponent(usernameFilter)}`;
      if (operationFilter) url += `&operation=${encodeURIComponent(operationFilter)}`;

      try {
        const res = await fetch(url, {
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('è·å–æ—¥å¿—å¤±è´¥:', errorText);
          alert(`è·å–æ—¥å¿—å¤±è´¥: ${errorText}`);
          return;
        }

        const logs = await res.json();

        const tbody = document.getElementById('logsTableBody');
        if (logs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">æš‚æ— æ—¥å¿—</td></tr>';
        } else {
          tbody.innerHTML = logs.map(log => {
            const hasData = log.submitted_data && Object.keys(log.submitted_data).length > 0;
            return `
              <tr onclick="showLogDetails(${log.id}, ${JSON.stringify(log).replace(/"/g, '&quot;')})">
                <td>${log.id}</td>
                <td>${log.username}</td>
                <td>${log.operation}</td>
                <td>${log.details || '-'}</td>
                <td>${log.ip_address || '-'}</td>
                <td>
                  <span class="status-badge status-${log.status}">
                    ${log.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
                  </span>
                </td>
                <td>${new Date(log.created_at).toLocaleString()}</td>
                <td>${hasData ? 'ğŸ“„' : ''}</td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
        alert(`è·å–æ—¥å¿—å¤±è´¥: ${error.message}`);
      }
    }

    function showLogDetails(logId, logData) {
      const log = typeof logData === 'string' ? JSON.parse(logData.replace(/&quot;/g, '"')) : logData;
      const modal = document.getElementById('logModal');
      const modalContent = document.getElementById('modalContent');

      let content = `
        <div class="modal-header">
          <h3>æ“ä½œè¯¦æƒ… - ID: ${log.id}</h3>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
      `;

      // åŸºæœ¬ä¿¡æ¯
      content += `
        <div class="data-field">
          <label>åŸºæœ¬ä¿¡æ¯</label>
          <pre>ç”¨æˆ·å: ${log.username}
æ“ä½œ: ${log.operation}
çŠ¶æ€: ${log.status}
æ—¶é—´: ${new Date(log.created_at).toLocaleString()}
IP: ${log.ip_address || '-'}</pre>
        </div>
      `;

      // è¯¦ç»†ä¿¡æ¯
      if (log.details) {
        content += `
          <div class="data-field">
            <label>è¯¦ç»†ä¿¡æ¯</label>
            <pre>${log.details}</pre>
          </div>
        `;
      }

      // æäº¤æ•°æ®
      if (log.submitted_data) {
        content += `
          <div class="data-field">
            <label>æäº¤æ•°æ®</label>
            <pre>${JSON.stringify(log.submitted_data, null, 2)}</pre>
          </div>
        `;

        // å¦‚æœæœ‰ä¸ªäººä¿¡æ¯é¢„è§ˆï¼Œç‰¹æ®Šæ˜¾ç¤º
        if (log.submitted_data.user_info_preview) {
          content += `
            <div class="data-field">
              <label>ä¸ªäººä¿¡æ¯é¢„è§ˆ (${log.submitted_data.user_info_length} å­—ç¬¦)</label>
              <pre>${log.submitted_data.user_info_preview}</pre>
            </div>
          `;
        }
      }

      modalContent.innerHTML = content;
      modal.classList.add('active');
    }

    async function fetchFeedbacks() {
      const typeFilter = document.getElementById('filterFeedbackType').value;
      const statusFilter = document.getElementById('filterFeedbackStatus').value;

      let url = '/api/admin/feedbacks?limit=50';
      if (typeFilter) url += `&feedback_type=${encodeURIComponent(typeFilter)}`;
      if (statusFilter) url += `&status=${encodeURIComponent(statusFilter)}`;

      try {
        const res = await fetch(url, {
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('è·å–åé¦ˆå¤±è´¥:', errorText);
          alert(`è·å–åé¦ˆå¤±è´¥: ${errorText}`);
          return;
        }

        const feedbacks = await res.json();

        const tbody = document.getElementById('feedbacksTableBody');
        if (feedbacks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">æš‚æ— åé¦ˆ</td></tr>';
        } else {
          tbody.innerHTML = feedbacks.map(f => {
            const typeNames = {
              'suggestion': 'åŠŸèƒ½å»ºè®®',
              'bug': 'BugæŠ¥å‘Š',
              'ux': 'ç”¨æˆ·ä½“éªŒ',
              'performance': 'æ€§èƒ½é—®é¢˜',
              'other': 'å…¶ä»–'
            };
            const statusNames = {
              'pending': 'å¾…å¤„ç†',
              'processing': 'å¤„ç†ä¸­',
              'resolved': 'å·²è§£å†³',
              'closed': 'å·²å…³é—­'
            };
            return `
              <tr>
                <td>${f.id}</td>
                <td>${f.username}</td>
                <td>${typeNames[f.feedback_type] || f.feedback_type}</td>
                <td>${'â˜…'.repeat(f.rating)}${'â˜†'.repeat(5 - f.rating)}</td>
                <td>${f.title}</td>
                <td>
                  <span class="status-badge status-${f.status}">
                    ${statusNames[f.status] || f.status}
                  </span>
                </td>
                <td>${new Date(f.created_at).toLocaleString()}</td>
                <td>
                  <button class="btn" style="padding: 5px 10px; font-size: 12px; width: auto;" onclick="showFeedbackDetails(${f.id}, ${JSON.stringify(f).replace(/"/g, '&quot;')})">
                    æŸ¥çœ‹è¯¦æƒ…
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('è·å–åé¦ˆå¤±è´¥:', error);
        alert(`è·å–åé¦ˆå¤±è´¥: ${error.message}`);
      }
    }

    function showFeedbackDetails(feedbackId, feedbackData) {
      const feedback = typeof feedbackData === 'string' ? JSON.parse(feedbackData.replace(/&quot;/g, '"')) : feedbackData;
      const modal = document.getElementById('logModal');
      const modalContent = document.getElementById('modalContent');

      const typeNames = {
        'suggestion': 'åŠŸèƒ½å»ºè®®',
        'bug': 'BugæŠ¥å‘Š',
        'ux': 'ç”¨æˆ·ä½“éªŒ',
        'performance': 'æ€§èƒ½é—®é¢˜',
        'other': 'å…¶ä»–'
      };
      const statusNames = {
        'pending': 'å¾…å¤„ç†',
        'processing': 'å¤„ç†ä¸­',
        'resolved': 'å·²è§£å†³',
        'closed': 'å·²å…³é—­'
      };

      let content = `
        <div class="modal-header">
          <h3>åé¦ˆè¯¦æƒ… - ID: ${feedback.id}</h3>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
      `;

      content += `
        <div class="data-field">
          <label>åŸºæœ¬ä¿¡æ¯</label>
          <pre>ç”¨æˆ·: ${feedback.username}
ç±»å‹: ${typeNames[feedback.feedback_type] || feedback.feedback_type}
è¯„åˆ†: ${feedback.rating}/5æ˜Ÿ
çŠ¶æ€: ${statusNames[feedback.status] || feedback.status}
æäº¤æ—¶é—´: ${new Date(feedback.created_at).toLocaleString()}
é¡µé¢URL: ${feedback.page_url || '-'}</pre>
        </div>
      `;

      content += `
        <div class="data-field">
          <label>æ ‡é¢˜</label>
          <pre>${feedback.title}</pre>
        </div>
      `;

      content += `
        <div class="data-field">
          <label>è¯¦ç»†æè¿°</label>
          <pre>${feedback.description}</pre>
        </div>
      `;

      if (feedback.contact_email) {
        content += `
          <div class="data-field">
            <label>è”ç³»æ–¹å¼</label>
            <pre>${feedback.contact_email}</pre>
          </div>
        `;
      }

      if (feedback.screenshot_path) {
        content += `
          <div class="data-field">
            <label>æˆªå›¾</label>
            <img src="/${feedback.screenshot_path}" style="max-width: 100%; border-radius: 5px;" onerror="this.style.display='none'">
          </div>
        `;
      }

      if (feedback.admin_reply) {
        content += `
          <div class="data-field">
            <label>ç®¡ç†å‘˜å›å¤</label>
            <pre>${feedback.admin_reply}</pre>
          </div>
        `;
      }

      modalContent.innerHTML = content;
      modal.classList.add('active');
    }

    async function createTempAccount() {
      const daysValid = parseInt(document.getElementById('daysValid').value);
      if (!daysValid || daysValid < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°ï¼ˆ1-365ï¼‰');
        return;
      }

      try {
        const res = await fetch('/api/admin/temp-accounts', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: `days_valid=${daysValid}`
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert(`åˆ›å»ºä¸´æ—¶è´¦å·å¤±è´¥: ${errorText}`);
          return;
        }

        const data = await res.json();
        if (data.success) {
          // æ˜¾ç¤ºè´¦å·ä¿¡æ¯
          alert(`âœ… ä¸´æ—¶è´¦å·åˆ›å»ºæˆåŠŸï¼\n\nç”¨æˆ·å: ${data.account.username}\nå¯†ç : ${data.account.password}\næœ‰æ•ˆæœŸ: ${data.account.days_valid}å¤©\nè¿‡æœŸæ—¶é—´: ${new Date(data.account.expires_at).toLocaleString()}\n\nè¯·å¤åˆ¶ä¿å­˜è´¦å·ä¿¡æ¯ï¼`);

          // åˆ·æ–°åˆ—è¡¨
          fetchTempAccounts();
          fetchStats();
        }
      } catch (error) {
        console.error('åˆ›å»ºä¸´æ—¶è´¦å·å¤±è´¥:', error);
        alert(`åˆ›å»ºä¸´æ—¶è´¦å·å¤±è´¥: ${error.message}`);
      }
    }

    async function fetchTempAccounts() {
      const showExpired = document.getElementById('showExpired').checked;
      let url = '/api/admin/temp-accounts';
      if (showExpired) {
        url += '?include_expired=true';
      }

      try {
        const res = await fetch(url, {
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('è·å–ä¸´æ—¶è´¦å·åˆ—è¡¨å¤±è´¥:', errorText);
          alert(`è·å–ä¸´æ—¶è´¦å·åˆ—è¡¨å¤±è´¥: ${errorText}`);
          return;
        }

        const accounts = await res.json();

        const tbody = document.getElementById('tempAccountsTableBody');
        if (accounts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">æš‚æ— ä¸´æ—¶è´¦å·</td></tr>';
        } else {
          tbody.innerHTML = accounts.map(acc => {
            const isExpired = acc.is_expired;
            const daysRemaining = acc.days_remaining;

            return `
              <tr>
                <td>
                  <strong>${acc.username}</strong>
                </td>
                <td>${new Date(acc.created_at).toLocaleString()}</td>
                <td>${acc.expires_at ? new Date(acc.expires_at).toLocaleString() : '-'}</td>
                <td>${daysRemaining !== null ? daysRemaining : '-'}</td>
                <td>
                  <span class="status-badge ${isExpired ? 'status-failed' : 'status-success'}">
                    ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}
                  </span>
                </td>
                <td>
                  <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteTempAccount('${acc.username}')">
                    åˆ é™¤
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('è·å–ä¸´æ—¶è´¦å·åˆ—è¡¨å¤±è´¥:', error);
        alert(`è·å–ä¸´æ—¶è´¦å·åˆ—è¡¨å¤±è´¥: ${error.message}`);
      }
    }

    async function deleteTempAccount(username) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸´æ—¶è´¦å· "${username}" å—ï¼Ÿ`)) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/temp-accounts/${username}`, {
          method: 'DELETE',
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert(`åˆ é™¤ä¸´æ—¶è´¦å·å¤±è´¥: ${errorText}`);
          return;
        }

        const data = await res.json();
        if (data.success) {
          alert('ä¸´æ—¶è´¦å·å·²åˆ é™¤');
          fetchTempAccounts();
          fetchStats();
        }
      } catch (error) {
        console.error('åˆ é™¤ä¸´æ—¶è´¦å·å¤±è´¥:', error);
        alert(`åˆ é™¤ä¸´æ—¶è´¦å·å¤±è´¥: ${error.message}`);
      }
    }

    async function fetchFiles() {
      const typeFilter = document.getElementById('filterFileType').value;
      const usernameFilter = document.getElementById('filterFileUsername').value;

      let url = '/api/admin/files?limit=100';
      if (typeFilter) url += `&file_type=${encodeURIComponent(typeFilter)}`;
      if (usernameFilter) url += `&username=${encodeURIComponent(usernameFilter)}`;

      try {
        const res = await fetch(url, {
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', errorText);
          alert(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${errorText}`);
          return;
        }

        const files = await res.json();

        const tbody = document.getElementById('filesTableBody');
        if (files.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš‚æ— æ–‡ä»¶</td></tr>';
        } else {
          tbody.innerHTML = files.map(file => {
            const typeNames = {
              'docx': 'DOCXæ–‡æ¡£',
              'user_info': 'ä¸ªäººä¿¡æ¯',
              'screenshot': 'åé¦ˆæˆªå›¾'
            };
            const sizeKB = (file.file_size / 1024).toFixed(2);
            return `
              <tr>
                <td>${file.id}</td>
                <td>${file.username}</td>
                <td>${typeNames[file.file_type] || file.file_type}</td>
                <td>${file.original_filename}</td>
                <td>${sizeKB} KB</td>
                <td>${new Date(file.created_at).toLocaleString()}</td>
                <td>
                  <button class="btn" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" onclick="downloadFile('${file.public_url}', '${file.original_filename}')">
                    ä¸‹è½½
                  </button>
                  <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteFile(${file.id})">
                    åˆ é™¤
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        alert(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`);
      }
    }

    function downloadFile(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.target = '_blank';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    async function deleteFile(fileId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }

      try {
        const res = await fetch(`/api/admin/files/${fileId}`, {
          method: 'DELETE',
          headers: {'Authorization': `Bearer ${token}`}
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${errorText}`);
          return;
        }

        const data = await res.json();
        if (data.success) {
          alert('æ–‡ä»¶å·²åˆ é™¤');
          fetchFiles();
        }
      } catch (error) {
        console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
        alert(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${error.message}`);
      }
    }

    function closeModal() {
      document.getElementById('logModal').classList.remove('active');
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('is_admin');
      window.location.href = '/login';
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetchStats();
      fetchUsers();
      fetchLogs();
      fetchFeedbacks();
      fetchTempAccounts();
      fetchFiles();

      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      const logModal = document.getElementById('logModal');
      if (logModal) {
        logModal.addEventListener('click', (e) => {
          if (e.target.id === 'logModal') {
            closeModal();
          }
        });
      }

      // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
      setInterval(() => {
        fetchStats();
        fetchLogs();
        fetchFeedbacks();
        fetchTempAccounts();
        fetchFiles();
      }, 30000);
    });
  </script>
</head>
<body>
  <header>
    <h1>ğŸ›ï¸ åå°ç®¡ç†ç³»ç»Ÿ</h1>
    <div class="user-info">
      <span>ğŸ‘¤ ç®¡ç†å‘˜: ${username}</span>
      <a href="/" class="btn">è¿”å›ä¸»é¡µ</a>
      <a href="#" class="logout" onclick="logout()">é€€å‡ºç™»å½•</a>
    </div>
  </header>

  <div class="container">
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="card">
      <h2>ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</h2>
      <div class="stats">
        <div class="stat-box">
          <h3>æ€»ç”¨æˆ·æ•°</h3>
          <div class="number" id="totalUsers">-</div>
        </div>
        <div class="stat-box">
          <h3>ä¸´æ—¶è´¦å·</h3>
          <div class="number" id="temporaryAccounts">-</div>
        </div>
        <div class="stat-box">
          <h3>å·²è¿‡æœŸ</h3>
          <div class="number" id="expiredAccounts">-</div>
        </div>
        <div class="stat-box">
          <h3>æ€»æ“ä½œæ•°</h3>
          <div class="number" id="totalOperations">-</div>
        </div>
        <div class="stat-box">
          <h3>æˆåŠŸæ“ä½œ</h3>
          <div class="number" id="successfulOps">-</div>
        </div>
        <div class="stat-box">
          <h3>å¤±è´¥æ“ä½œ</h3>
          <div class="number" id="failedOps">-</div>
        </div>
        <div class="stat-box">
          <h3>å¾…å¤„ç†åé¦ˆ</h3>
          <div class="number" id="pendingFeedbacks">-</div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div class="card">
      <h2>ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>ç”¨æˆ·å</th>
            <th>ç®¡ç†å‘˜</th>
            <th>æ³¨å†Œæ—¶é—´</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr>
            <td colspan="4" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ä¸´æ—¶è´¦å·ç®¡ç† -->
    <div class="card">
      <h2>ğŸ”‘ ä¸´æ—¶è´¦å·ç®¡ç†</h2>

      <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <input id="daysValid" type="number" value="7" min="1" max="365" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100px;">
          <button class="btn" onclick="createTempAccount()">ğŸ ç”Ÿæˆæ–°è´¦å·</button>
          <button class="btn" onclick="fetchTempAccounts()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
          <label style="display: flex; align-items: center; gap: 5px; margin-left: auto; cursor: pointer;">
            <input type="checkbox" id="showExpired" onchange="fetchTempAccounts()">
            æ˜¾ç¤ºå·²è¿‡æœŸè´¦å·
          </label>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>è¿‡æœŸæ—¶é—´</th>
            <th>å‰©ä½™å¤©æ•°</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tempAccountsTableBody">
          <tr>
            <td colspan="6" style="text-align: center; color: #999;">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½æ•°æ®</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ç”¨æˆ·åé¦ˆ -->
    <div class="card">
      <h2>ğŸ’¬ ç”¨æˆ·åé¦ˆ</h2>

      <!-- åé¦ˆç­›é€‰æ¡† -->
      <div class="filter-box">
        <select id="filterFeedbackType">
          <option value="">æ‰€æœ‰ç±»å‹</option>
          <option value="suggestion">åŠŸèƒ½å»ºè®®</option>
          <option value="bug">BugæŠ¥å‘Š</option>
          <option value="ux">ç”¨æˆ·ä½“éªŒ</option>
          <option value="performance">æ€§èƒ½é—®é¢˜</option>
          <option value="other">å…¶ä»–</option>
        </select>
        <select id="filterFeedbackStatus">
          <option value="">æ‰€æœ‰çŠ¶æ€</option>
          <option value="pending">å¾…å¤„ç†</option>
          <option value="processing">å¤„ç†ä¸­</option>
          <option value="resolved">å·²è§£å†³</option>
          <option value="closed">å·²å…³é—­</option>
        </select>
        <button onclick="fetchFeedbacks()">åº”ç”¨ç­›é€‰</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>ç”¨æˆ·</th>
            <th>ç±»å‹</th>
            <th>è¯„åˆ†</th>
            <th>æ ‡é¢˜</th>
            <th>çŠ¶æ€</th>
            <th>æäº¤æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="feedbacksTableBody">
          <tr>
            <td colspan="8" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- æ–‡ä»¶ç®¡ç† -->
    <div class="card">
      <h2>ğŸ“ æ–‡ä»¶ç®¡ç†</h2>

      <!-- æ–‡ä»¶ç­›é€‰æ¡† -->
      <div class="filter-box">
        <select id="filterFileType">
          <option value="">æ‰€æœ‰ç±»å‹</option>
          <option value="docx">DOCXæ–‡æ¡£</option>
          <option value="user_info">ä¸ªäººä¿¡æ¯</option>
          <option value="screenshot">åé¦ˆæˆªå›¾</option>
        </select>
        <input id="filterFileUsername" type="text" placeholder="ç­›é€‰ç”¨æˆ·å">
        <button onclick="fetchFiles()">åº”ç”¨ç­›é€‰</button>
        <button class="btn" onclick="fetchFiles()" style="margin-left: auto;">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>ç”¨æˆ·</th>
            <th>ç±»å‹</th>
            <th>æ–‡ä»¶å</th>
            <th>å¤§å°</th>
            <th>ä¸Šä¼ æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="filesTableBody">
          <tr>
            <td colspan="7" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>

      <div class="footer-note" style="margin-top: 15px;">
        ğŸ’¡ æ–‡ä»¶å­˜å‚¨åœ¨ Supabase Storage ä¸­ï¼Œæ”¯æŒ DOCX æ–‡æ¡£ã€ä¸ªäººä¿¡æ¯ TXT æ–‡ä»¶å’Œåé¦ˆæˆªå›¾çš„æŸ¥çœ‹ã€ä¸‹è½½å’Œåˆ é™¤
      </div>
    </div>

    <!-- æ“ä½œæ—¥å¿— -->
    <div class="card">
      <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>

      <!-- ç­›é€‰æ¡† -->
      <div class="filter-box">
        <input id="filterUsername" type="text" placeholder="ç­›é€‰ç”¨æˆ·å">
        <select id="filterOperation">
          <option value="">æ‰€æœ‰æ“ä½œ</option>
          <option value="æ³¨å†Œ">æ³¨å†Œ</option>
          <option value="ç™»å½•">ç™»å½•</option>
          <option value="æäº¤æ–‡æ¡£å¤„ç†">æäº¤æ–‡æ¡£å¤„ç†</option>
          <option value="æäº¤åé¦ˆ">æäº¤åé¦ˆ</option>
          <option value="æ–‡æ¡£å¤„ç†å¤±è´¥">æ–‡æ¡£å¤„ç†å¤±è´¥</option>
        </select>
        <button onclick="fetchLogs()">åº”ç”¨ç­›é€‰</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>ç”¨æˆ·å</th>
            <th>æ“ä½œ</th>
            <th>è¯¦æƒ…</th>
            <th>IP</th>
            <th>çŠ¶æ€</th>
            <th>æ—¶é—´</th>
            <th>æ•°æ®</th>
          </tr>
        </thead>
        <tbody id="logsTableBody">
          <tr>
            <td colspan="8" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="logModal" class="modal">
      <div class="modal-content">
        <div id="modalContent"></div>
      </div>
    </div>
  </div>
</body>
</html>
